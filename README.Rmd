---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# VirtualPals üê®: Virtual Species and Niche Modeling in R

[![R-CMD-check](https://github.com/your-username/VirtualPals/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/your-username/VirtualPals/actions/workflows/R-CMD-check.yaml)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**VirtualPals** is an R package for creating virtual species by defining their ecological niches in a multi-dimensional environmental space. It allows you to project these niches onto geographic landscapes to simulate species distributions. This tool is ideal for researchers and students who need to test Species Distribution Model (SDM) algorithms, explore ecological theory, or generate plausible data for educational purposes.

The core of the package is its ability to define a species' fundamental niche as a fully-rotatable, N-dimensional ellipsoid.

---

## üöÄ Key Features

* **Flexible Niche Definition**: Define species niches as 2D or 3D ellipsoids with full control over the center (optimum), axes (tolerances), and rotation.
* **Geographic Projection**: Generate geographic suitability maps from environmental raster data based on your defined niche.
* **Multiple Output Types**: Create maps of:
    * **Binary** suitability (presence/absence).
    * **Probabilistic** suitability based on a Gaussian decay from the niche center.
    * Raw **Mahalanobis distance** to the niche optimum.
* **Data Filtering**: Easily extract points from any dataset (e.g., climate data) that fall within a defined niche.
* **Rich Visualization**: Integrates with `ggplot2` and `plotly` for clear and interactive visualizations of both niches and geographic distributions.

---

## üì¶ Installation

You can install the development version of VirtualPals from GitHub:

```{r}
# install.packages("devtools")
devtools::install_github("paanwaris/VirtualPals")
```

---

## üêæ Core Workflow: A Complete Example

This example demonstrates the full workflow, from creating environmental data to defining a niche and visualizing the results.

### Step 1: Load Libraries

```{r}
library(VirtualPals)
library(terra)
library(ggplot2)
```

### Step 2: Create Environmental Data

For this example, we'll create a simple virtual world with two environmental variables: "Temperature" and "Rainfall".

```{r}
# Create a blank raster template
world <- rast(xmin = -180, xmax = 180, ymin = -90, ymax = 90, res = 1, crs = "WGS84")

# Create a temperature gradient (cold at poles, warm at equator)
temp <- init(world, fun = \(y) 30 - 60 * abs(y / 90))
names(temp) <- "Temperature"

# Create a rainfall gradient (wet in north, dry in south)
rainfall <- init(world, fun = \(y) 1500 + 1500 * (y / 90))
names(rainfall) <- "Rainfall"

# Stack the layers
env_rasters <- c(temp, rainfall)

# Plot the environmental layers
plot(env_rasters, col = hcl.colors(100, "Lajolla"))
```


### Step 3: Define the Species Niche

We'll define the niche for our virtual species, *Virtualis palsicus*. It prefers warm, moderately wet conditions. We use a **named vector** for `center` to ensure variables are matched correctly. We'll also rotate the niche slightly.

```{r}
# Define the niche using a rotated ellipse
vpals_niche <- build_ellipsoid(
  center = c(Temperature = 20, Rainfall = 1800),
  axes = c(5, 400), # Tolerance of ¬±5¬∞C and ¬±400mm rain
  angles = -pi / 8  # Rotate by -22.5 degrees
)
```

### Step 4: Generate Suitability Maps

Now, we project this abstract niche onto our environmental map to find suitable habitats.

```{r}
# Generate a binary presence/absence map
suit_binary <- generate_suitability(env_rasters, vpals_niche, output_type = "binary")

# Generate a continuous probabilistic map
suit_prob <- generate_suitability(env_rasters, vpals_niche, output_type = "probabilistic")

# Plot the resulting distributions
par(mfrow = c(1, 2))
plot(suit_binary, main = "Binary Distribution of V. palsicus", col = c("grey90", "#2E8B57"))
plot(suit_prob, main = "Probabilistic Distribution of V. palsicus", col = hcl.colors(100, "Viridis"))
```


### Step 5: Visualize the Niche in Environmental Space

It's crucial to see how the niche relates to the available environments. We'll plot the niche space, the available environments (our raster data), and the subset of environments that are suitable.

```{r}
# Convert the raster data to points for plotting (subsample for performance)
env_points <- as.data.frame(env_rasters, na.rm = TRUE)
env_points_sample <- env_points[sample(nrow(env_points), 10000), ]

# Use our function to find which of these points are inside the niche
points_inside <- points_in_ellipsoid(vpals_niche, env_points_sample)
points_inside <- as.data.frame(points_inside)

# Plot with ggplot2
ggplot() +
  # Plot all available environments in the background
  geom_point(data = env_points_sample, aes(x = Temperature, y = Rainfall),
             color = "grey80", shape = 16, alpha = 0.5) +
  # Highlight the suitable points (inside the niche)
  geom_point(data = points_inside, aes(x = Temperature, y = Rainfall),
             color = "#006400", shape = 16) +
  # Draw the niche boundary
  geom_path(data = vpals_niche$surface, aes(x = x, y = y),
            color = "#CD5C5C", linewidth = 1.2) +
  labs(
    title = "Ecological Niche of Virtualis palsicus",
    subtitle = "Showing available vs. suitable environments",
    x = "Temperature (¬∞C)",
    y = "Rainfall (mm/year)"
  ) +
  theme_minimal()
```


---

## üõ†Ô∏è Function Overview

* `build_ellipsoid()`: Creates a 2D or 3D ellipsoid object with specified center, axes, and rotation.
* `generate_suitability()`: Projects an `ellipsoid` niche onto `SpatRaster` environmental layers to create a suitability map.
* `points_in_ellipsoid()`: Filters a `data.frame` or `matrix` to return only the points that fall inside an `ellipsoid`.
